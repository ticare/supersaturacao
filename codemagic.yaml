workflows:
  ios-ipa-build:
    name: Gerar IPA para Teste
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      vars:
        # Ajuste estes valores conforme seu projeto
        XCODE_PROJECT: "clone.xcodeproj"  # Nome do seu projeto
        BUNDLE_IDENTIFIER: "com.exemplo.clone"  # Seu bundle ID
      xcode: latest
      cocoapods: default
    scripts:
      - name: Diagn√≥stico detalhado do projeto
        script: |
          echo "üîç DIAGN√ìSTICO DETALHADO DO PROJETO"
          echo "=================================="
          
          echo -e "\n1. üìÅ Estrutura de arquivos:"
          ls -la
          
          echo -e "\n2. üì± Projetos iOS encontrados:"
          find . -name "*.xcodeproj" -type d
          find . -name "*.xcworkspace" -type d
          
          echo -e "\n3. üìã Arquivos de configura√ß√£o:"
          find . -name "Podfile" -type f && echo "‚úÖ Podfile encontrado" || echo "‚ùå Podfile n√£o encontrado"
          find . -name "*.podspec" -type f && echo "‚úÖ Podspec encontrado" || echo "‚ùå Podspec n√£o encontrado"
          find . -name "Package.swift" -type f && echo "‚úÖ Package.swift encontrado" || echo "‚ùå Package.swift n√£o encontrado"
          
          PROJECT_FILE=$(find . -name "*.xcodeproj" -type d | head -n 1)
          WORKSPACE_FILE=$(find . -name "*.xcworkspace" -type d | head -n 1)
          
          if [ -n "$WORKSPACE_FILE" ]; then
            echo -e "\n4. üèóÔ∏è  Analisando workspace: $WORKSPACE_FILE"
            xcodebuild -list -workspace "$WORKSPACE_FILE" || echo "‚ùå Erro ao listar workspace"
          elif [ -n "$PROJECT_FILE" ]; then
            echo -e "\n4. üèóÔ∏è  Analisando projeto: $PROJECT_FILE"
            xcodebuild -list -project "$PROJECT_FILE" || echo "‚ùå Erro ao listar projeto"
          else
            echo -e "\n‚ùå Nenhum projeto iOS encontrado!"
            exit 1
          fi
          
          echo -e "\n5. üìã Verificando Info.plist:"
          find . -name "Info.plist" -type f | head -5
          
          echo -e "\n6. üîç Verificando schemes compartilhados:"
          if [ -n "$PROJECT_FILE" ]; then
            ls -la "$PROJECT_FILE/xcshareddata/xcschemes/" 2>/dev/null || echo "‚ùå Nenhum scheme compartilhado"
          fi
          if [ -n "$WORKSPACE_FILE" ]; then
            ls -la "$WORKSPACE_FILE/xcshareddata/xcschemes/" 2>/dev/null || echo "‚ùå Nenhum scheme compartilhado no workspace"
          fi
          
          echo -e "\n=================================="
          
      - name: Analisar targets e schemes dispon√≠veis
        script: |
          echo "=== Analisando projeto ==="
          PROJECT_FILE=$(find . -name "*.xcodeproj" -type d | head -n 1)
          
          if [ -n "$PROJECT_FILE" ]; then
            echo "Projeto encontrado: $PROJECT_FILE"
            xcodebuild -list -project "$PROJECT_FILE"
          else
            echo "‚ùå Nenhum projeto .xcodeproj encontrado!"
            exit 1
          fi
          
      - name: Instalar depend√™ncias (se houver CocoaPods)
        script: |
          if [ -f "Podfile" ]; then
            echo "üì¶ Instalando CocoaPods..."
            pod install
          else
            echo "‚úÖ Nenhum Podfile encontrado, pulando CocoaPods"
          fi
          
      - name: Resolver problemas comuns de build
        script: |
          echo "üîß Resolvendo problemas comuns..."
          
          PROJECT_FILE=$(find . -name "*.xcodeproj" -type d | head -n 1)
          WORKSPACE_FILE=$(find . -name "*.xcworkspace" -type d | head -n 1)
          
          # Limpar builds anteriores
          echo "üßπ Limpando builds anteriores..."
          rm -rf build/
          rm -rf DerivedData/
          
          # Se for Flutter, configurar adequadamente
          if [ -f "pubspec.yaml" ]; then
            echo "üê¶ Projeto Flutter detectado!"
            echo "Configurando Flutter..."
            
            # Instalar depend√™ncias Flutter
            flutter pub get
            
            # Configurar para iOS
            cd ios
            pod install --repo-update
            cd ..
            
            # Build Flutter
            flutter build ios --release --no-codesign
            
            echo "‚úÖ Build Flutter conclu√≠do"
          fi
          
          # Verificar e corrigir configura√ß√µes comuns
          if [ -n "$PROJECT_FILE" ] || [ -n "$WORKSPACE_FILE" ]; then
            echo "üîß Verificando configura√ß√µes do projeto..."
            
            # Procurar por arquivos pbxproj
            PBXPROJ_FILE=$(find . -name "project.pbxproj" | head -n 1)
            
            if [ -n "$PBXPROJ_FILE" ]; then
              echo "üìù Verificando configura√ß√µes no project.pbxproj..."
              
              # Verificar se h√° configura√ß√µes problem√°ticas
              grep -q "ENABLE_BITCODE" "$PBXPROJ_FILE" && echo "‚ö†Ô∏è  ENABLE_BITCODE encontrado" || echo "‚úÖ ENABLE_BITCODE OK"
              grep -q "SWIFT_VERSION" "$PBXPROJ_FILE" && echo "‚úÖ Swift version configurado" || echo "‚ö†Ô∏è  Swift version n√£o encontrado"
            fi
          fi
          
      - name: Configurar assinatura de c√≥digo (desenvolvimento)
        script: |
          echo "üîë Configurando assinatura para desenvolvimento..."
          
          PROJECT_FILE=$(find . -name "*.xcodeproj" -type d | head -n 1)
          FIRST_TARGET=$(xcodebuild -list -project "$PROJECT_FILE" | grep -A 1000 "Targets:" | grep -v "Targets:" | grep -v "Build Configurations:" | sed 's/^[[:space:]]*//' | grep -v '^$' | head -n 1)
          
          # Configurar para desenvolvimento sem assinatura espec√≠fica
          xcodebuild -project "$PROJECT_FILE" \
                     -target "$FIRST_TARGET" \
                     -configuration Release \
                     -showBuildSettings | grep PRODUCT_BUNDLE_IDENTIFIER || true
                     
      - name: Build do arquivo IPA
        script: |
          echo "üöÄ Iniciando build do IPA..."
          
          PROJECT_FILE=$(find . -name "*.xcodeproj" -type d | head -n 1)
          WORKSPACE_FILE=$(find . -name "*.xcworkspace" -type d | head -n 1)
          
          # Determinar se usar workspace ou project
          if [ -n "$WORKSPACE_FILE" ]; then
            echo "üì¶ Usando workspace: $WORKSPACE_FILE"
            PROJECT_ARG="-workspace $WORKSPACE_FILE"
          else
            echo "üìÅ Usando project: $PROJECT_FILE"
            PROJECT_ARG="-project $PROJECT_FILE"
          fi
          
          # Listar todos os schemes dispon√≠veis
          echo "üìã Schemes dispon√≠veis:"
          if [ -n "$WORKSPACE_FILE" ]; then
            xcodebuild -list -workspace "$WORKSPACE_FILE"
          else
            xcodebuild -list -project "$PROJECT_FILE"
          fi
          
          # Pegar o primeiro scheme dispon√≠vel
          if [ -n "$WORKSPACE_FILE" ]; then
            FIRST_SCHEME=$(xcodebuild -list -workspace "$WORKSPACE_FILE" | grep -A 1000 "Schemes:" | grep -v "Schemes:" | sed 's/^[[:space:]]*//' | grep -v '^
          
      - name: Gerar arquivo IPA
        script: |
          echo "üì± Gerando arquivo IPA..."
          
          # Procurar pelo arquivo .app em v√°rios locais poss√≠veis
          APP_FILE=""
          
          # Locais poss√≠veis do arquivo .app
          SEARCH_PATHS=(
            "build"
            "build/Release-iphoneos"
            "build/*.xcarchive/Products/Applications"
            "$HOME/Library/Developer/Xcode/DerivedData/*/Build/Products/Release-iphoneos"
            "."
          )
          
          for path in "${SEARCH_PATHS[@]}"; do
            echo "üîç Procurando em: $path"
            FOUND_APP=$(find $path -name "*.app" -type d 2>/dev/null | head -n 1)
            if [ -n "$FOUND_APP" ]; then
              APP_FILE="$FOUND_APP"
              echo "‚úÖ App encontrado: $APP_FILE"
              break
            fi
          done
          
          if [ -z "$APP_FILE" ]; then
            echo "‚ùå Arquivo .app n√£o encontrado!"
            echo "üìÅ Estrutura de diret√≥rios:"
            find . -name "*.app" -type d 2>/dev/null || echo "Nenhum arquivo .app encontrado em lugar algum"
            
            echo -e "\nüìÅ Conte√∫do do diret√≥rio build:"
            ls -la build/ 2>/dev/null || echo "Diret√≥rio build n√£o existe"
            
            echo -e "\nüìÅ Todos os arquivos gerados:"
            find . -type f -name "*" | grep -E '\.(app|ipa|xcarchive)' || echo "Nenhum arquivo relevante encontrado"
            
            exit 1
          fi
          
          # Verificar se o .app √© v√°lido
          if [ ! -d "$APP_FILE" ]; then
            echo "‚ùå $APP_FILE n√£o √© um diret√≥rio v√°lido"
            exit 1
          fi
          
          echo "üìã Conte√∫do do app:"
          ls -la "$APP_FILE"
          
          # Criar estrutura para IPA
          rm -rf Payload
          mkdir -p Payload
          cp -R "$APP_FILE" Payload/
          
          # Verificar se copiou corretamente
          echo "üìã Conte√∫do do Payload:"
          ls -la Payload/
          
          # Criar arquivo IPA
          echo "üóúÔ∏è  Criando arquivo ZIP/IPA..."
          zip -r app.ipa Payload/
          
          if [ -f "app.ipa" ]; then
            echo "üéâ IPA gerado com sucesso!"
            ls -la app.ipa
          else
            echo "‚ùå Falha ao criar arquivo IPA"
            exit 1
          fi
          
      - name: Verificar IPA gerado
        script: |
          if [ -f "app.ipa" ]; then
            echo "‚úÖ Arquivo IPA criado com sucesso!"
            echo "üìä Tamanho do arquivo:"
            ls -lh app.ipa
            
            echo -e "\nüìã Conte√∫do do IPA:"
            unzip -l app.ipa | head -20
          else
            echo "‚ùå Falha na gera√ß√£o do IPA"
            exit 1
          fi
    
    artifacts:
      - app.ipa
      - build/**/*.app
      - build/**/*.xcarchive
      - /tmp/xcodebuild_logs/*.log
    
    publishing:
      email:
        recipients:
          - seuemail@exemplo.com  # Substitua pelo seu email
        notify:
          success: true
          failure: true | head -n 1)
          else
            FIRST_SCHEME=$(xcodebuild -list -project "$PROJECT_FILE" | grep -A 1000 "Schemes:" | grep -v "Schemes:" | sed 's/^[[:space:]]*//' | grep -v '^
          
      - name: Gerar arquivo IPA
        script: |
          echo "üì± Gerando arquivo IPA..."
          
          # Procurar pelo arquivo .app gerado
          APP_FILE=$(find build -name "*.app" | head -n 1)
          
          if [ -n "$APP_FILE" ]; then
            echo "‚úÖ App encontrado: $APP_FILE"
            
            # Criar estrutura para IPA
            mkdir -p Payload
            cp -R "$APP_FILE" Payload/
            
            # Criar arquivo IPA
            zip -r app.ipa Payload/
            
            echo "üéâ IPA gerado com sucesso: app.ipa"
            ls -la app.ipa
          else
            echo "‚ùå Arquivo .app n√£o encontrado!"
            echo "Arquivos dispon√≠veis em build/:"
            find build -type f 2>/dev/null || echo "Diret√≥rio build n√£o existe"
            exit 1
          fi
          
      - name: Verificar IPA gerado
        script: |
          if [ -f "app.ipa" ]; then
            echo "‚úÖ Arquivo IPA criado com sucesso!"
            echo "üìä Tamanho do arquivo:"
            ls -lh app.ipa
            
            echo -e "\nüìã Conte√∫do do IPA:"
            unzip -l app.ipa | head -20
          else
            echo "‚ùå Falha na gera√ß√£o do IPA"
            exit 1
          fi
    
    artifacts:
      - app.ipa
      - build/**/*.app
      - build/**/*.xcarchive
      - /tmp/xcodebuild_logs/*.log
    
    publishing:
      email:
        recipients:
          - seuemail@exemplo.com  # Substitua pelo seu email
        notify:
          success: true
          failure: true | head -n 1)
          fi
          
          echo "üéØ Scheme selecionado: $FIRST_SCHEME"
          
          # Build mais simples primeiro (sem archive)
          echo "üî® Fazendo build simples primeiro..."
          xcodebuild \
            $PROJECT_ARG \
            -scheme "$FIRST_SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            PROVISIONING_PROFILE="" \
            clean build
          
          # Se o build simples funcionou, tentar o archive
          if [ $? -eq 0 ]; then
            echo "‚úÖ Build simples OK, tentando archive..."
            xcodebuild archive \
              $PROJECT_ARG \
              -scheme "$FIRST_SCHEME" \
              -configuration Release \
              -archivePath "$PWD/build/$FIRST_SCHEME.xcarchive" \
              -sdk iphoneos \
              -destination 'generic/platform=iOS' \
              ONLY_ACTIVE_ARCH=NO \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGN_IDENTITY="" \
              PROVISIONING_PROFILE=""
          else
            echo "‚ùå Build simples falhou, tentando sem clean..."
            xcodebuild \
              $PROJECT_ARG \
              -scheme "$FIRST_SCHEME" \
              -configuration Release \
              -sdk iphoneos \
              -destination 'generic/platform=iOS' \
              ONLY_ACTIVE_ARCH=NO \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGN_IDENTITY="" \
              PROVISIONING_PROFILE="" \
              build
          fi
          
      - name: Gerar arquivo IPA
        script: |
          echo "üì± Gerando arquivo IPA..."
          
          # Procurar pelo arquivo .app gerado
          APP_FILE=$(find build -name "*.app" | head -n 1)
          
          if [ -n "$APP_FILE" ]; then
            echo "‚úÖ App encontrado: $APP_FILE"
            
            # Criar estrutura para IPA
            mkdir -p Payload
            cp -R "$APP_FILE" Payload/
            
            # Criar arquivo IPA
            zip -r app.ipa Payload/
            
            echo "üéâ IPA gerado com sucesso: app.ipa"
            ls -la app.ipa
          else
            echo "‚ùå Arquivo .app n√£o encontrado!"
            echo "Arquivos dispon√≠veis em build/:"
            find build -type f 2>/dev/null || echo "Diret√≥rio build n√£o existe"
            exit 1
          fi
          
      - name: Verificar IPA gerado
        script: |
          if [ -f "app.ipa" ]; then
            echo "‚úÖ Arquivo IPA criado com sucesso!"
            echo "üìä Tamanho do arquivo:"
            ls -lh app.ipa
            
            echo -e "\nüìã Conte√∫do do IPA:"
            unzip -l app.ipa | head -20
          else
            echo "‚ùå Falha na gera√ß√£o do IPA"
            exit 1
          fi
    
    artifacts:
      - app.ipa
      - build/**/*.app
      - build/**/*.xcarchive
      - /tmp/xcodebuild_logs/*.log
    
    publishing:
      email:
        recipients:
          - seuemail@exemplo.com  # Substitua pelo seu email
        notify:
          success: true
          failure: true