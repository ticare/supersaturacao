workflows:
  ios-ipa-build:
    name: Gerar IPA para Teste
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      vars:
        # Ajuste estes valores conforme seu projeto
        XCODE_PROJECT: "APP RAM SupersaturaÃ§Ã£o"  # Nome do seu projeto
        BUNDLE_IDENTIFIER: "fabiano.oliveira@ticare.com.br"  # Seu bundle ID
      xcode: latest
      cocoapods: default
    scripts:
      - name: DiagnÃ³stico detalhado do projeto
        script: |
          echo "ğŸ” DIAGNÃ“STICO DETALHADO DO PROJETO"
          echo "=================================="
          
          echo -e "\n1. ğŸ“ Estrutura de arquivos:"
          ls -la
          
          echo -e "\n2. ğŸ“± Projetos iOS encontrados:"
          find . -name "*.xcodeproj" -type d
          find . -name "*.xcworkspace" -type d
          
          echo -e "\n3. ğŸ“‹ Arquivos de configuraÃ§Ã£o:"
          find . -name "Podfile" -type f && echo "âœ… Podfile encontrado" || echo "âŒ Podfile nÃ£o encontrado"
          find . -name "*.podspec" -type f && echo "âœ… Podspec encontrado" || echo "âŒ Podspec nÃ£o encontrado"
          find . -name "Package.swift" -type f && echo "âœ… Package.swift encontrado" || echo "âŒ Package.swift nÃ£o encontrado"
          
          PROJECT_FILE=$(find . -name "*.xcodeproj" -type d | head -n 1)
          WORKSPACE_FILE=$(find . -name "*.xcworkspace" -type d | head -n 1)
          
          if [ -n "$WORKSPACE_FILE" ]; then
            echo -e "\n4. ğŸ—ï¸  Analisando workspace: $WORKSPACE_FILE"
            xcodebuild -list -workspace "$WORKSPACE_FILE" || echo "âŒ Erro ao listar workspace"
          elif [ -n "$PROJECT_FILE" ]; then
            echo -e "\n4. ğŸ—ï¸  Analisando projeto: $PROJECT_FILE"
            xcodebuild -list -project "$PROJECT_FILE" || echo "âŒ Erro ao listar projeto"
          else
            echo -e "\nâŒ Nenhum projeto iOS encontrado!"
            exit 1
          fi
          
          echo -e "\n5. ğŸ“‹ Verificando Info.plist:"
          find . -name "Info.plist" -type f | head -5
          
          echo -e "\n6. ğŸ” Verificando schemes compartilhados:"
          if [ -n "$PROJECT_FILE" ]; then
            ls -la "$PROJECT_FILE/xcshareddata/xcschemes/" 2>/dev/null || echo "âŒ Nenhum scheme compartilhado"
          fi
          if [ -n "$WORKSPACE_FILE" ]; then
            ls -la "$WORKSPACE_FILE/xcshareddata/xcschemes/" 2>/dev/null || echo "âŒ Nenhum scheme compartilhado no workspace"
          fi
          
          echo -e "\n=================================="
          
      - name: Analisar targets e schemes disponÃ­veis
        script: |
          echo "=== Analisando projeto ==="
          PROJECT_FILE=$(find . -name "*.xcodeproj" -type d | head -n 1)
          
          if [ -n "$PROJECT_FILE" ]; then
            echo "Projeto encontrado: $PROJECT_FILE"
            xcodebuild -list -project "$PROJECT_FILE"
          else
            echo "âŒ Nenhum projeto .xcodeproj encontrado!"
            exit 1
          fi
          
      - name: Instalar dependÃªncias (se houver CocoaPods)
        script: |
          if [ -f "Podfile" ]; then
            echo "ğŸ“¦ Instalando CocoaPods..."
            pod install
          else
            echo "âœ… Nenhum Podfile encontrado, pulando CocoaPods"
          fi
          
      - name: Resolver problemas comuns de build
        script: |
          echo "ğŸ”§ Resolvendo problemas comuns..."
          
          PROJECT_FILE=$(find . -name "*.xcodeproj" -type d | head -n 1)
          WORKSPACE_FILE=$(find . -name "*.xcworkspace" -type d | head -n 1)
          
          # Limpar builds anteriores
          echo "ğŸ§¹ Limpando builds anteriores..."
          rm -rf build/
          rm -rf DerivedData/
          
          # Se for Flutter, configurar adequadamente
          if [ -f "pubspec.yaml" ]; then
            echo "ğŸ¦ Projeto Flutter detectado!"
            echo "Configurando Flutter..."
            
            # Instalar dependÃªncias Flutter
            flutter pub get
            
            # Configurar para iOS
            cd ios
            pod install --repo-update
            cd ..
            
            # Build Flutter
            flutter build ios --release --no-codesign
            
            echo "âœ… Build Flutter concluÃ­do"
          fi
          
          # Verificar e corrigir configuraÃ§Ãµes comuns
          if [ -n "$PROJECT_FILE" ] || [ -n "$WORKSPACE_FILE" ]; then
            echo "ğŸ”§ Verificando configuraÃ§Ãµes do projeto..."
            
            # Procurar por arquivos pbxproj
            PBXPROJ_FILE=$(find . -name "project.pbxproj" | head -n 1)
            
            if [ -n "$PBXPROJ_FILE" ]; then
              echo "ğŸ“ Verificando configuraÃ§Ãµes no project.pbxproj..."
              
              # Verificar se hÃ¡ configuraÃ§Ãµes problemÃ¡ticas
              grep -q "ENABLE_BITCODE" "$PBXPROJ_FILE" && echo "âš ï¸  ENABLE_BITCODE encontrado" || echo "âœ… ENABLE_BITCODE OK"
              grep -q "SWIFT_VERSION" "$PBXPROJ_FILE" && echo "âœ… Swift version configurado" || echo "âš ï¸  Swift version nÃ£o encontrado"
            fi
          fi
          
      - name: Configurar assinatura de cÃ³digo (desenvolvimento)
        script: |
          echo "ğŸ”‘ Configurando assinatura para desenvolvimento..."
          
          PROJECT_FILE=$(find . -name "*.xcodeproj" -type d | head -n 1)
          FIRST_TARGET=$(xcodebuild -list -project "$PROJECT_FILE" | grep -A 1000 "Targets:" | grep -v "Targets:" | grep -v "Build Configurations:" | sed 's/^[[:space:]]*//' | grep -v '^$' | head -n 1)
          
          # Configurar para desenvolvimento sem assinatura especÃ­fica
          xcodebuild -project "$PROJECT_FILE" \
                     -target "$FIRST_TARGET" \
                     -configuration Release \
                     -showBuildSettings | grep PRODUCT_BUNDLE_IDENTIFIER || true
                     
      - name: Build do arquivo IPA
        script: |
          echo "ğŸš€ Iniciando build do IPA..."
          
          PROJECT_FILE=$(find . -name "*.xcodeproj" -type d | head -n 1)
          WORKSPACE_FILE=$(find . -name "*.xcworkspace" -type d | head -n 1)
          
          # Determinar se usar workspace ou project
          if [ -n "$WORKSPACE_FILE" ]; then
            echo "ğŸ“¦ Usando workspace: $WORKSPACE_FILE"
            PROJECT_ARG="-workspace $WORKSPACE_FILE"
          else
            echo "ğŸ“ Usando project: $PROJECT_FILE"
            PROJECT_ARG="-project $PROJECT_FILE"
          fi
          
          # Listar todos os schemes disponÃ­veis
          echo "ğŸ“‹ Schemes disponÃ­veis:"
          if [ -n "$WORKSPACE_FILE" ]; then
            xcodebuild -list -workspace "$WORKSPACE_FILE"
          else
            xcodebuild -list -project "$PROJECT_FILE"
          fi
          
          # Pegar o primeiro scheme disponÃ­vel
          if [ -n "$WORKSPACE_FILE" ]; then
            FIRST_SCHEME=$(xcodebuild -list -workspace "$WORKSPACE_FILE" | grep -A 1000 "Schemes:" | grep -v "Schemes:" | sed 's/^[[:space:]]*//' | grep -v '^
          
      - name: Gerar arquivo IPA
        script: |
          echo "ğŸ“± Gerando arquivo IPA..."
          
          # Procurar pelo arquivo .app em vÃ¡rios locais possÃ­veis
          APP_FILE=""
          
          # Locais possÃ­veis do arquivo .app
          SEARCH_PATHS=(
            "build"
            "build/Release-iphoneos"
            "build/*.xcarchive/Products/Applications"
            "$HOME/Library/Developer/Xcode/DerivedData/*/Build/Products/Release-iphoneos"
            "."
          )
          
          for path in "${SEARCH_PATHS[@]}"; do
            echo "ğŸ” Procurando em: $path"
            FOUND_APP=$(find $path -name "*.app" -type d 2>/dev/null | head -n 1)
            if [ -n "$FOUND_APP" ]; then
              APP_FILE="$FOUND_APP"
              echo "âœ… App encontrado: $APP_FILE"
              break
            fi
          done
          
          if [ -z "$APP_FILE" ]; then
            echo "âŒ Arquivo .app nÃ£o encontrado!"
            echo "ğŸ“ Estrutura de diretÃ³rios:"
            find . -name "*.app" -type d 2>/dev/null || echo "Nenhum arquivo .app encontrado em lugar algum"
            
            echo -e "\nğŸ“ ConteÃºdo do diretÃ³rio build:"
            ls -la build/ 2>/dev/null || echo "DiretÃ³rio build nÃ£o existe"
            
            echo -e "\nğŸ“ Todos os arquivos gerados:"
            find . -type f -name "*" | grep -E '\.(app|ipa|xcarchive)' || echo "Nenhum arquivo relevante encontrado"
            
            exit 1
          fi
          
          # Verificar se o .app Ã© vÃ¡lido
          if [ ! -d "$APP_FILE" ]; then
            echo "âŒ $APP_FILE nÃ£o Ã© um diretÃ³rio vÃ¡lido"
            exit 1
          fi
          
          echo "ğŸ“‹ ConteÃºdo do app:"
          ls -la "$APP_FILE"
          
          # Criar estrutura para IPA
          rm -rf Payload
          mkdir -p Payload
          cp -R "$APP_FILE" Payload/
          
          # Verificar se copiou corretamente
          echo "ğŸ“‹ ConteÃºdo do Payload:"
          ls -la Payload/
          
          # Criar arquivo IPA
          echo "ğŸ—œï¸  Criando arquivo ZIP/IPA..."
          zip -r app.ipa Payload/
          
          if [ -f "app.ipa" ]; then
            echo "ğŸ‰ IPA gerado com sucesso!"
            ls -la app.ipa
          else
            echo "âŒ Falha ao criar arquivo IPA"
            exit 1
          fi
          
      - name: Verificar IPA gerado
        script: |
          if [ -f "app.ipa" ]; then
            echo "âœ… Arquivo IPA criado com sucesso!"
            echo "ğŸ“Š Tamanho do arquivo:"
            ls -lh app.ipa
            
            echo -e "\nğŸ“‹ ConteÃºdo do IPA:"
            unzip -l app.ipa | head -20
          else
            echo "âŒ Falha na geraÃ§Ã£o do IPA"
            exit 1
          fi
    
    artifacts:
      - app.ipa
      - build/**/*.app
      - build/**/*.xcarchive
      - /tmp/xcodebuild_logs/*.log
    
    publishing:
      email:
        recipients:
          - seuemail@exemplo.com  # Substitua pelo seu email
        notify:
          success: true
          failure: true | head -n 1)
          else
            FIRST_SCHEME=$(xcodebuild -list -project "$PROJECT_FILE" | grep -A 1000 "Schemes:" | grep -v "Schemes:" | sed 's/^[[:space:]]*//' | grep -v '^
          
      - name: Gerar arquivo IPA
        script: |
          echo "ğŸ“± Gerando arquivo IPA..."
          
          # Procurar pelo arquivo .app gerado
          APP_FILE=$(find build -name "*.app" | head -n 1)
          
          if [ -n "$APP_FILE" ]; then
            echo "âœ… App encontrado: $APP_FILE"
            
            # Criar estrutura para IPA
            mkdir -p Payload
            cp -R "$APP_FILE" Payload/
            
            # Criar arquivo IPA
            zip -r app.ipa Payload/
            
            echo "ğŸ‰ IPA gerado com sucesso: app.ipa"
            ls -la app.ipa
          else
            echo "âŒ Arquivo .app nÃ£o encontrado!"
            echo "Arquivos disponÃ­veis em build/:"
            find build -type f 2>/dev/null || echo "DiretÃ³rio build nÃ£o existe"
            exit 1
          fi
          
      - name: Verificar IPA gerado
        script: |
          if [ -f "app.ipa" ]; then
            echo "âœ… Arquivo IPA criado com sucesso!"
            echo "ğŸ“Š Tamanho do arquivo:"
            ls -lh app.ipa
            
            echo -e "\nğŸ“‹ ConteÃºdo do IPA:"
            unzip -l app.ipa | head -20
          else
            echo "âŒ Falha na geraÃ§Ã£o do IPA"
            exit 1
          fi
    
    artifacts:
      - app.ipa
      - build/**/*.app
      - build/**/*.xcarchive
      - /tmp/xcodebuild_logs/*.log
    
    publishing:
      email:
        recipients:
          - seuemail@exemplo.com  # Substitua pelo seu email
        notify:
          success: true
          failure: true | head -n 1)
          fi
          
          echo "ğŸ¯ Scheme selecionado: $FIRST_SCHEME"
          
          # Build mais simples primeiro (sem archive)
          echo "ğŸ”¨ Fazendo build simples primeiro..."
          xcodebuild \
            $PROJECT_ARG \
            -scheme "$FIRST_SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            PROVISIONING_PROFILE="" \
            clean build
          
          # Se o build simples funcionou, tentar o archive
          if [ $? -eq 0 ]; then
            echo "âœ… Build simples OK, tentando archive..."
            xcodebuild archive \
              $PROJECT_ARG \
              -scheme "$FIRST_SCHEME" \
              -configuration Release \
              -archivePath "$PWD/build/$FIRST_SCHEME.xcarchive" \
              -sdk iphoneos \
              -destination 'generic/platform=iOS' \
              ONLY_ACTIVE_ARCH=NO \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGN_IDENTITY="" \
              PROVISIONING_PROFILE=""
          else
            echo "âŒ Build simples falhou, tentando sem clean..."
            xcodebuild \
              $PROJECT_ARG \
              -scheme "$FIRST_SCHEME" \
              -configuration Release \
              -sdk iphoneos \
              -destination 'generic/platform=iOS' \
              ONLY_ACTIVE_ARCH=NO \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGN_IDENTITY="" \
              PROVISIONING_PROFILE="" \
              build
          fi
          
      - name: Gerar arquivo IPA
        script: |
          echo "ğŸ“± Gerando arquivo IPA..."
          
          # Procurar pelo arquivo .app gerado
          APP_FILE=$(find build -name "*.app" | head -n 1)
          
          if [ -n "$APP_FILE" ]; then
            echo "âœ… App encontrado: $APP_FILE"
            
            # Criar estrutura para IPA
            mkdir -p Payload
            cp -R "$APP_FILE" Payload/
            
            # Criar arquivo IPA
            zip -r app.ipa Payload/
            
            echo "ğŸ‰ IPA gerado com sucesso: app.ipa"
            ls -la app.ipa
          else
            echo "âŒ Arquivo .app nÃ£o encontrado!"
            echo "Arquivos disponÃ­veis em build/:"
            find build -type f 2>/dev/null || echo "DiretÃ³rio build nÃ£o existe"
            exit 1
          fi
          
      - name: Verificar IPA gerado
        script: |
          if [ -f "app.ipa" ]; then
            echo "âœ… Arquivo IPA criado com sucesso!"
            echo "ğŸ“Š Tamanho do arquivo:"
            ls -lh app.ipa
            
            echo -e "\nğŸ“‹ ConteÃºdo do IPA:"
            unzip -l app.ipa | head -20
          else
            echo "âŒ Falha na geraÃ§Ã£o do IPA"
            exit 1
          fi
    
    artifacts:
      - app.ipa
      - build/**/*.app
      - build/**/*.xcarchive
      - /tmp/xcodebuild_logs/*.log
    
    publishing:
      email:
        recipients:
          - fabiano.oliveira@ticare.com.br  # Substitua pelo seu email
        notify:
          success: true
          failure: true