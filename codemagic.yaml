workflows:
  ios-flutter-build:
    name: Flutter iOS - Gerar IPA
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      vars:
        # ConfiguraÃ§Ãµes do seu projeto
        BUNDLE_IDENTIFIER: "fabiano.oliveira@ticare.com.br"
        APP_NAME: "APP RAM SupersaturaÃ§Ã£o"
      flutter: stable
      xcode: latest
      cocoapods: default

    scripts:
      - name: DiagnÃ³stico do projeto Flutter
        script: |
          echo "ğŸ¦ DIAGNÃ“STICO DO PROJETO FLUTTER"
          echo "================================="

          # Verificar se Ã© projeto Flutter
          if [ ! -f "pubspec.yaml" ]; then
            echo "âŒ Este nÃ£o Ã© um projeto Flutter! pubspec.yaml nÃ£o encontrado."
            exit 1
          fi

          echo "âœ… Projeto Flutter confirmado"

          echo -e "\nğŸ“ Estrutura do projeto:"
          ls -la

          echo -e "\nğŸ“± Verificando pasta ios:"
          ls -la ios/ 2>/dev/null || echo "âŒ Pasta ios nÃ£o encontrada"

          echo -e "\nğŸ“‹ ConteÃºdo do pubspec.yaml:"
          cat pubspec.yaml | head -20

          echo -e "\nğŸ” Verificando configuraÃ§Ãµes iOS:"
          ls -la ios/Runner/ 2>/dev/null || echo "âŒ Pasta ios/Runner nÃ£o encontrada"

          # Verificar se existe o projeto Xcode
          if [ -f "ios/Runner.xcodeproj/project.pbxproj" ]; then
            echo "âœ… Projeto Xcode encontrado"
          else
            echo "âŒ Projeto Xcode nÃ£o encontrado"
          fi

      - name: Limpar e configurar Flutter
        script: |
          echo "ğŸ§¹ Limpando projeto Flutter..."

          # Limpar Flutter
          flutter clean

          # Verificar instalaÃ§Ã£o do Flutter
          echo "ğŸ” Verificando Flutter:"
          flutter --version
          flutter doctor -v

          # Instalar dependÃªncias
          echo "ğŸ“¦ Instalando dependÃªncias Flutter..."
          flutter pub get

          # Verificar se pub get funcionou
          if [ $? -eq 0 ]; then
            echo "âœ… DependÃªncias Flutter instaladas"
          else
            echo "âŒ Erro ao instalar dependÃªncias Flutter"
            exit 1
          fi

      - name: Configurar projeto iOS
        script: |
          echo "ğŸ Configurando projeto iOS..."

          cd ios

          # Verificar se existe Podfile
          if [ ! -f "Podfile" ]; then
            echo "âŒ Podfile nÃ£o encontrado!"
            echo "Gerando Podfile bÃ¡sico..."
            cd ..
            flutter build ios --config-only
            cd ios
          fi

          echo "ğŸ“¦ Instalando CocoaPods..."
          pod deintegrate 2>/dev/null || echo "Nenhuma integraÃ§Ã£o anterior para remover"
          pod install --repo-update

          if [ $? -eq 0 ]; then
            echo "âœ… CocoaPods instalado com sucesso"
          else
            echo "âŒ Erro ao instalar CocoaPods"
            exit 1
          fi

          cd ..

          # Gerar arquivos de configuraÃ§Ã£o iOS
          echo "âš™ï¸ Gerando configuraÃ§Ãµes iOS..."
          flutter build ios --config-only --release

          # Verificar se Generated.xcconfig foi criado
          if [ -f "ios/Flutter/Generated.xcconfig" ]; then
            echo "âœ… Generated.xcconfig criado com sucesso"
            echo "ğŸ“‹ ConteÃºdo do Generated.xcconfig:"
            cat ios/Flutter/Generated.xcconfig
          else
            echo "âŒ Generated.xcconfig nÃ£o foi criado!"
            echo "Tentando criar manualmente..."
            mkdir -p ios/Flutter
            echo "FLUTTER_ROOT=/Users/builder/programs/flutter" > ios/Flutter/Generated.xcconfig
            echo "FLUTTER_APPLICATION_PATH=/Users/builder/clone" >> ios/Flutter/Generated.xcconfig
            echo "COCOAPODS_PARALLEL_CODE_SIGN=true" >> ios/Flutter/Generated.xcconfig
          fi

      - name: Configurar Bundle ID e assinatura
        script: |
          echo "ğŸ”‘ Configurando Bundle ID e assinatura..."

          # Configurar Bundle ID usando Flutter
          if [ -n "$BUNDLE_IDENTIFIER" ]; then
            echo "ğŸ“± Configurando Bundle ID: $BUNDLE_IDENTIFIER"
            
            # Verificar se o arquivo Info.plist existe
            if [ -f "ios/Runner/Info.plist" ]; then
              echo "âœ… Info.plist encontrado"
            else
              echo "âŒ Info.plist nÃ£o encontrado"
            fi
            
            # Listar schemes disponÃ­veis
            echo "ğŸ“‹ Schemes disponÃ­veis:"
            xcodebuild -list -workspace ios/Runner.xcworkspace 2>/dev/null || xcodebuild -list -project ios/Runner.xcodeproj
          fi

      - name: Build Flutter iOS
        script: |
          echo "ğŸš€ Fazendo build do Flutter para iOS..."

          # Build Flutter para iOS sem codesign
          flutter build ios \
            --release \
            --no-codesign \
            --target-platform ios \
            --dart-define=flutter.inspector.structuredErrors=false

          if [ $? -eq 0 ]; then
            echo "âœ… Build Flutter iOS concluÃ­do com sucesso"
          else
            echo "âŒ Erro no build Flutter iOS"
            
            echo "ğŸ” Verificando logs de erro..."
            # Tentar build mais verboso
            flutter build ios --release --no-codesign --verbose
            exit 1
          fi

          # Verificar se o .app foi gerado
          APP_PATH="build/ios/iphoneos/Runner.app"
          if [ -d "$APP_PATH" ]; then
            echo "âœ… Arquivo .app gerado: $APP_PATH"
            ls -la "$APP_PATH"
          else
            echo "âŒ Arquivo .app nÃ£o encontrado em $APP_PATH"
            echo "ğŸ” Procurando arquivo .app..."
            find build -name "*.app" -type d 2>/dev/null || echo "Nenhum .app encontrado"
          fi

      - name: Gerar arquivo IPA
        script: |
          echo "ğŸ“± Gerando arquivo IPA..."

          # Localizar o arquivo .app
          APP_FILE=$(find build -name "*.app" -type d | head -n 1)

          if [ -z "$APP_FILE" ]; then
            echo "âŒ Arquivo .app nÃ£o encontrado!"
            echo "ğŸ“ ConteÃºdo do diretÃ³rio build:"
            find build -type d -name "*.app" 2>/dev/null || echo "Nenhum diretÃ³rio .app encontrado"
            find build -type f -name "Runner" 2>/dev/null || echo "Nenhum executÃ¡vel Runner encontrado"
            exit 1
          fi

          echo "âœ… App encontrado: $APP_FILE"

          # Verificar conteÃºdo do .app
          echo "ğŸ“‹ ConteÃºdo do app:"
          ls -la "$APP_FILE"

          # Verificar se o executÃ¡vel existe
          APP_NAME=$(basename "$APP_FILE" .app)
          if [ -f "$APP_FILE/$APP_NAME" ]; then
            echo "âœ… ExecutÃ¡vel encontrado: $APP_FILE/$APP_NAME"
          else
            echo "âŒ ExecutÃ¡vel nÃ£o encontrado em $APP_FILE/$APP_NAME"
            echo "ğŸ“‹ ConteÃºdo detalhado:"
            find "$APP_FILE" -type f
          fi

          # Criar estrutura Payload
          echo "ğŸ“¦ Criando estrutura IPA..."
          rm -rf Payload
          mkdir Payload
          cp -R "$APP_FILE" Payload/

          # Verificar cÃ³pia
          if [ -d "Payload/$(basename "$APP_FILE")" ]; then
            echo "âœ… App copiado para Payload"
          else
            echo "âŒ Erro ao copiar app para Payload"
            exit 1
          fi

          # Criar IPA
          echo "ğŸ—œï¸ Criando arquivo IPA..."
          zip -r "app-ram-supersaturacao.ipa" Payload/

          if [ -f "app-ram-supersaturacao.ipa" ]; then
            echo "ğŸ‰ IPA gerado com sucesso!"
            ls -lh "app-ram-supersaturacao.ipa"
          else
            echo "âŒ Falha ao criar IPA"
            exit 1
          fi

      - name: Verificar IPA final
        script: |
          if [ -f "app-ram-supersaturacao.ipa" ]; then
            echo "âœ… VerificaÃ§Ã£o final do IPA:"
            echo "ğŸ“Š Tamanho: $(ls -lh app-ram-supersaturacao.ipa | awk '{print $5}')"
            echo "ğŸ“‹ Estrutura interna:"
            unzip -l app-ram-supersaturacao.ipa | head -10
            
            # Verificar se o IPA contÃ©m o executÃ¡vel
            unzip -l app-ram-supersaturacao.ipa | grep -E "(Runner|executable)" && echo "âœ… ExecutÃ¡vel presente" || echo "âš ï¸ ExecutÃ¡vel pode estar ausente"
          else
            echo "âŒ IPA nÃ£o foi gerado"
            exit 1
          fi

    artifacts:
      - app-ram-supersaturacao.ipa
      - build/ios/iphoneos/*.app/**
      - ios/Flutter/Generated.xcconfig

    publishing:
      email:
        recipients:
          - fabiano.oliveira@ticare.com.br
        notify:
          success: true
          failure: true
